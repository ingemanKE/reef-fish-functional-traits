---
title: "02-data-project"
author: "Kurt Ingeman"
date: "9/20/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

```{r}

library(dplyr)
library(ggplot2)
library(tidyr)
library(here)

library(gt)
library(kableExtra)

```



# read in data and merge with spp list 
```{r}

df <- read.csv(here("Data", "Marianas_fishabund_numperm2_sector.csv")) %>% 
  rename(SECTOR = ANALYSIS_SEC)

sum(df$N) # 1217 surveys

# remove standard error columns for reshape
df_wide <- df %>% 
  select(!contains("_SE"))

# reshape data 
df_long <- df_wide %>% 
  pivot_longer(cols = 8:500, names_to ="SPECIES", values_to = "DENSITY") %>% 
  filter(DENSITY > 0)

# How many surveys?
length(unique(df_long$SPECIES)) #471

# read in species list
spp <- read.csv(here("Data", "FISH_SPECIES_04-21-2020.csv")) %>% 
  select(SPECIES, TAXONNAME, FAMILY, TROPHIC, TROPHIC_SIMPLE, TROPHIC_MONREP)

# merge with species list to incorporate trophic groups 
df_long <-  left_join(df_long, spp, by = "SPECIES")


```

# data summaries
```{r}



richness_yr <- df_long %>% 
  group_by(ANALYSIS_YEAR) %>% 
  summarise(RICHNESS = length(unique(SPECIES)))

 gt(richness_yr) %>%
  tab_header(
    title = "S&P 500",
    subtitle = "A table"
  )
 
 library(kableExtra)
dt <- mtcars[1:5, 1:4]

# HTML table
kbl(dt, caption = "Demo Table") %>%
  kable_styling(bootstrap_options = "striped",
                full_width = F) %>%
  add_header_above(c(" ", "Group 1" = 2, "Group 2[note]" = 2)) %>%
  footnote(c("table footnote"))


table_yr <- df_long %>% 
  group_by(ANALYSIS_YEAR) %>% 
  mutate(SURVEYS = sum(N)) %>% 
  summarise(RICHNESS = length(unique(SPECIES)), 
         RICH_DENSE = RICHNESS / SURVEYS) %>% 
  slice(1) %>% 
  arrange(desc(RICH_DENSE))
  


table_sector <- df_long %>% 
  group_by(ANALYSIS_YEAR, SECTOR) %>% 
  mutate(SURVEYS = sum(N), 
         RICHNESS = length(unique(SPECIES)), 
         RICH_DENSE = RICHNESS / SURVEYS) %>% 
  slice(1) %>% 
  select(SECTOR, ANALYSIS_YEAR, SURVEYS, RICHNESS, RICH_DENSE) %>% 
  arrange(desc(RICH_DENSE)) %>% ungroup()
  
```


# data visulization
```{r}

ggplot(data = table_sector, aes(x = RICHNESS, y = SURVEYS)) +
  geom_point() +
  geom_smooth(method = "lm")

ggplot(data = table_sector, aes(x = RICHNESS, y = SURVEYS, color = factor(ANALYSIS_YEAR))) +
  geom_point() +
  geom_smooth(method = "lm")




```

# data calculations
```{r}

df_troph <- df_long %>% 
  group_by(ANALYSIS_YEAR, SECTOR, TROPHIC_MONREP) %>% 
  mutate(TROPHIC_DENSE = sum(DENSITY)) %>% 
  mutate(YEAR = factor(ANALYSIS_YEAR), 
         SECTOR = factor(SECTOR)) %>% 
  ungroup()

ggplot(df_troph, aes(x = TROPHIC_MONREP, y = TROPHIC_DENSE)) +
  geom_bar(stat = "identity") + 
  facet_grid( vars(YEAR), vars(SECTOR)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
  
  
  
```















